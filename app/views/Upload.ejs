<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Course Roster</title>
    <link rel="stylesheet" href="/MainPage.css" />
    <!-- #f9f9f9 -->
    <style>
      form {
        width: 30%;
      }
      /* Styling for the drag and drop area */
      #drag-drop-area {
        border: 2px dashed #b2b1b1;
        padding: 20px;
        text-align: center;
        background-color: #f9f9f999;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
      }

      #drag-drop-area.hover {
        background-color: #e0d7cac6;
        transition: background-color 0.3s ease;
      }

      /* Styling for the "Submit" button */
      button[type="submit"] {
        background-color: rgb(160, 131, 84);
        color: white;
        padding: 10px 20px;
        margin: 8px 0;
        border: none;
        cursor: pointer;
        width: 40%;
        border-radius: 10px;
        font-size: 18px;
      }

      button[type="submit"]:hover {
        background-color: rgb(65, 42, 4);
      }

      /* Styling for the "Back to Homepage" button */
      .btn-upload {
        margin-top: 10px;
        padding: 10px 20px;
        font-size: 16px;
        color: white;
        background-color: rgb(160, 131, 84);
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        width: 20%;
        border-radius: 10px;
        font-size: 18px;
      }

      .btn-upload:hover {
        background-color: #b86a38;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Peer Assessment Tool</h1>
    </header>

    <main>
      <section id="intro">
        <h2>Upload Course Roster</h2>
      </section>
      <% if (uploaded==0 || uploaded==2) { %> <% if (uploaded==2) { %>
      <h4>File not processed. Please verify file format and try again.</h4>
      <% } %>
      <br /><br />
      <form>
        <div
          id="drag-drop-area"
          ondrop="handleDrop(event)"
          ondragover="handleDragOver(event)"
          ondragleave="handleDragLeave(event)"
          onclick="triggerFileInput()"
        >
          <p>Drag and drop a CSV file here or click to select</p>
          <input
            type="file"
            accept=".csv"
            name="file"
            id="csv"
            style="display: none"
          />
        </div>
        <br />
        <button
          class="btn-upload"
          type="submit"
          id="btn-submit"
          style="display: none"
        >
          Submit
        </button>
      </form>

      <% } %> <% if (uploaded==1) { %>
      <h3>File uploaded successfully.</h3>
      <% } %>
      <br />
      <button class="btn-upload" onclick="window.location.href='/'">
        Back to Homepage
      </button>

      <script>
        const form = document.querySelector("form");
        const fileInput = document.getElementById("csv");
        const dragDropArea = document.getElementById("drag-drop-area");

        // Handle drag over
        function handleDragOver(event) {
          event.preventDefault();
          dragDropArea.classList.add("hover");
        }

        // Handle drag leave
        function handleDragLeave() {
          dragDropArea.classList.remove("hover");
        }

        // Handle file drop
        function handleDrop(event) {
          event.preventDefault();
          dragDropArea.classList.remove("hover");
          const files = event.dataTransfer.files;

          if (files.length > 0) {
            // Verify file has .csv extension
            const fileExtension = files[0].name.split(".").pop().toLowerCase();
            if (fileExtension !== "csv") {
              alert("Please select a valid .csv file.");
            } else {
              fileInput.files = files;
              dragDropArea.innerHTML = `<p>${files[0].name}</p>`;
              document.getElementById("btn-submit").removeAttribute("style");
            }
          }
        }

        // Handle file selection from input
        fileInput.addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            dragDropArea.innerHTML = `<p>${file.name}</p>`;
            document.getElementById("btn-submit").removeAttribute("style");
          }
        });

        // Trigger file input when drag-drop area is clicked
        function triggerFileInput() {
          fileInput.click();
        }

        // Handle form submission
        form.addEventListener("submit", (event) => {
          event.preventDefault(); // Prevent the default form submission
          const file = fileInput.files[0];

          const formData = new FormData();
          formData.append("file", file);

          // Send file to the server using fetch
          fetch("/upload/0", {
            method: "POST",
            body: formData,
          })
            .then((res) => res.json())
            .then((data) => {
              let { processed } = data;
              if (processed) {
                alert(
                  "File uploaded successfully. All students have been added to the system."
                );
                window.location.href = "/"; // Successful upload
              } else {
                window.location.href = "/upload/2"; // Failed upload
              }
            })
            .catch((error) => {
              console.error("Error uploading file:", error);
              alert("There was an error uploading the file. Please try again.");
            });
        });
      </script>
    </main>

    <footer>
      <p>
        &copy; 2024 Peer Assessment Tool. All rights kinda reserved. Product of
        Team ThinkVision
      </p>
    </footer>
  </body>
</html>
